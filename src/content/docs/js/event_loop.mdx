---
layout: ../../../layouts/BlogPost.astro
title: 이벤트 루프
---

import { Image } from "astro:assets";
import eventLoopImg from "../../../assets/images/event_loop/event_loop.png";

### event loop
javascript는 싱글스레드이다.    
하지만 브라우저를 보면 애니메이션 효과와 네트워크 요청이 동시에 이루어지는 것 처럼 보인다. 

이것을 가능하게 하는것이 브라우저에 내장된 `event loop`이다.    
`event loop`를 통해 js는 동시성을 지원한다. 

이벤트 루프는 콜스택에 쌓여있는 작업이 있는지 확인한다.    
그리고 task queue에 작업이 있고 콜스택이 비어있을경우 FIFO로 콜스택으로 이동시켜 작업을 진행한다. 

### event loop & browser
<Image
  src={eventLoopImg}
  alt="이벤트 루프와 브라우저"
  widths={[500, 1000]}
  sizes="(max-width: 640px) 100vw, 500px"
  formats={["avif", "webp", "png"]}
  quality={80}
  loading="lazy"
  decoding="async"
/>

javascript는 실행 컨텍스트에서 살펴보았듯이 코드를 해석하면서 실행 컨텍스트 스택에 pop, push 한다.     
이때 실행 컨텍스트 스택이 위의 `콜스택`이다.    
javascript는 싱글스레드인만큼 콜스택이 하나로 이루어져있다. 

힙은 메모리가 저장되는 공간이다. 

소스코드 평가와 실행을 빼고는 브라우저 또는 Node.js가 담당한다.

setTimeout은 비동기로 동작한다. 이 작업을 평가하고 실행하는 것은 javascript엔진이 한다.    
하지만 타이머 설정이나 콜백 함수 등록 같은 작업은 node.js와 브라우저가 한다.    
이때 필요한게 `태스크 큐 (task queue)`이다.


### task queue

비동기 함수 혹은 이벤트 핸들러가 일시적으로 보관되는 영역이다.

콜스택은 함수들이 쌓이는 곳, task queue는 비동기 작업이 완료될때 대기 시키는 곳이다.

### event loop 와 task queue 실행 예시

```javascript
function foo() {
 console.log('foo');
}
function bar() {
 console.log('bar');
}
setTimeout(foo, 0); // 0초(실제는 4ms) 후에 foo 함수가 호출된다.
bar();
```

1. 전역 코드 평가 -> 전역 실행 컨텍스트 생성 -> 콜스택 push
2. 전역 코드 실행 -> setTimeout 호출 -> setTimeout 실행 컨텍스트 생성 -> 콜스택 push
3. setTimeout 실행 -> 브라우저에게 특정 시간 이후에 등록하도록 설정 -> 타이머 만료시 태스크 큐에 등록하는 일은 브라우저가
4. 브라우저 내의 타이머가 만료되면(최소 4ms 후), 브라우저는 콜백 함수 foo를 **태스크 큐(Task Queue)에 푸시(Push)**한다. (이때 바로 실행되는 것이 아니라 대기 상태가 된다.)
5. bar 함수 호출 -> bar 실행 컨텍스트 생성 -> 콜스택 push 
> 여기서 bar가 콜스택에서 일하고 있을때 foo의 타이머가 끝난다고 해도 콜스택이 비어있을 경우 태스크 큐에서 꺼내져서 실행되는것이 원칙이라 foo는 계속 기다려야 한다.    
그리고 4번과 5번은 동시에 실행된다.
6. 전역 코드실행 종료 -> 전역 실행 컨텍스트가 콜스택에서 pop 
7. 비어있는 콜스택 감지 -> 태스크 큐에 있던 foo가 이벤트 루프에 의해 콜스택으로 push -> 실행

